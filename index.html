<!DOCTYPE html>
<html>
<head>
  <title>Alphaworm Iteration Thirteen</title>

  <meta charset="utf-8" />
  <link rel="stylesheet" type="text/css" href="client/uistyle.css">

  <script src="./client/RequestAnimationFrame.js" type="text/javascript"></script>
  <script src="./client/proton-1.0.0.js" type="text/javascript"></script>
  <script src="./client/tween.min.js" type="text/javascript"></script>
  <script src="./client/messagebroker.js" type="text/javascript"></script>
  <script src="./client/messagehandler.js" type="text/javascript"></script>
  <script src="./client/game.js" type="text/javascript"></script>
  <script src="./common/food.js" type="text/javascript"></script>
  <script src="./common/gamearea.js" type="text/javascript"></script>
  <script src="./common/worm.js" type="text/javascript"></script>
  <script src="./common/messages.js" type="text/javascript"></script>
  <script src="./client/sha-hash.js" type="text/javascript"></script>

  <!-- Pass the websocketURI to the client -->
  <script src="/websocketURI.js"></script>
  <script type="text/javascript">   

    function initAlphaworm() {
      // TODO: Improve game init in the near future
      messageHandler = new MessageHandler();

      /* Drop effect */
      var r = document.getElementById("login").getBoundingClientRect();
      var endpoint = document.getElementById('logo')
        .getBoundingClientRect().bottom + r.height;
      
      var tween = new TWEEN.Tween( { y: -600 } )
        .to( { y: endpoint }, 1000 )
        .easing( TWEEN.Easing.Bounce.Out )
        .onStart(function(){

          var tmp = document.getElementById("login");
          tmp.style.visibility = "visible";

        })
        .onUpdate( function () {

          var tmp = document.getElementById("login");
          tmp.style.top = this.y+"px";
          
        }).start();
    }
  
    function logout() {
      // Not the most elegant way to logout, but now we will just reload the webpage
      var hidePlayers = HideEffect('onlineplayers');
      var hideRanking = HideEffect('rankinglist');
    
      hideRanking.onComplete(function(){
	location.reload();
      });
            
      hidePlayers.start();
      window.setTimeout(function(){
	hideRanking.start();
      },250);
    
    }

    function login() {
      // Check user input fields
      if (document.getElementById("username").value && document.getElementById("password").value) {
        // Send login request
        var msg = messages.message.LOGIN_REQUEST.new();
        msg.username = document.getElementById("username").value;
        msg.passwordhash = Sha1.hash(document.getElementById("password").value);
        messageHandler.send(msg);
        messageHandler.username = msg.username;
      }
    }

    function register() {
      // Check user input fields
      if (document.getElementById("username").value && document.getElementById("password").value) {
        // Send registration request
        var msg = messages.message.REGISTRATION_REQUEST.new();
        msg.username = document.getElementById("username").value;
        msg.passwordhash = Sha1.hash(document.getElementById("password").value);
        messageHandler.send(msg);
      }
    }

    function chatKeypress(event) {
      event.preventDefault;
      //console.log("event.which:", event.which, "event.keyCode:", event.keyCode, "event.charCode:", event.charCode);
      if (event.which == 13 || event.keyCode == 13) {
        // Send text if length > 0
        var chatmsg = document.getElementById('chatmessage').value;
        if (chatmsg) {
          var msg = messages.message.CHAT_MESSAGE.new();
          msg.username = messageHandler.getUsername();
          msg.text = chatmsg;
          messageHandler.send(msg);
          document.getElementById('chatmessage').value = "";
        }
      }
    return true; // NOTE! return false; does not update textbox
    }

    function challenge(username) {
      console.log("challenge", username);
      messageHandler.challenge(username);
    }

    function gameInput(event) {
      messageHandler.game.handleInput(event);
      return true; 
    }

    function acceptChallenge(challenger) {
      console.log("acceptChallenge", challenger);
      messageHandler.acceptChallenge(challenger);
    }

    function rejectChallenge(challenger) {
      console.log("rejectChallenge", challenger);
      messageHandler.rejectChallenge(challenger);
    }
  </script>
</head>

<body onload="initAlphaworm()" onkeypress="return gameInput(event)">

  <div id="particles"></div>
  <audio id="login_success_audio" preload="auto">
    <source src="./media/loginok.wav" type="audio/wav">
  </audio>
  <audio id="register_success_audio" preload="auto">
    <source src="./media/regok.wav" type="audio/wav">
  </audio>
  <audio id="challenge_request_audio" preload="auto">
    <source src="./media/challenge.wav" type="audio/wav">
  </audio>
  <audio id="challenge_accept_audio" preload="auto">
    <source src="./media/accept.wav" type="audio/wav">
  </audio>
  <audio id="challenge_reject_audio" preload="auto">
    <source src="./media/reject.wav" type="audio/wav">
  </audio>
  <audio id="gameover_audio" preload="auto" >
    <source src="./media/gameover.wav" type="audio/wav">
  </audio>
  <audio id="correctletter_audio" preload="auto">
    <source src="./media/correctletter.wav" type="audio/wav">
  </audio>
  <audio id="fail_audio" preload="auto">
    <source src="./media/fail.wav" type="audio/wav">
  </audio>
  <audio id="word_complete_audio" preload="auto">
    <source src="./media/wordcomplete.wav" type="audio/wav">
  </audio>
  <audio src="../media/dyst.ogg" id="game_music" preload="auto"></audio>

  <div id="completed" class="wordcomplete">
    Word complete!
  </div>
  <div class="container">

    <div class="wide">
      <div class="sidearea">
	<div id="onlineplayers">
	  <fieldset class="ui-border ui-container">
            <legend><h3>Single player</h3></legend>
            <div >
              <div id="you"></div>
            </div>
	    <input id="start_game" type="submit" class="button ui-space-blue" value="StartGame" onclick="messageHandler.game.startGame()">
	    <input id="logout_button" class="button ui-space-blue" type="submit" value="Exit" onclick="logout();">
	  </fieldset>
	  <br/>
	  <fieldset class="ui-border ui-container">
            <legend><h3>Online players</h3></legend>
            <div id="onlineplayerlist">
              <div id="onlineplayer">Wobot</div>
            </div>
	  </fieldset>
	</div>

	 <div id="feedback">
          <h1 id="feedbacktext"></h1>
         </div>
	 
      </div>
      <div id="logo">
        <img src="media/alphaworm-logo.png">
	<div id="logotext">
	  <h1>A Planetscale Hunger For Words.</h1>
	</div>
      </div>
      <div class="sidearea">
	<div id="rankinglist">
	  <fieldset class="ui-border ui-container">
            <legend><h3>Player ranking</h3></legend>
            <div id="rankedplayers">
              <div id="rankedplayer">Wobot</div>
            </div>
	  </fieldset>
	</div>
	<div id="score">
	</div>
      </div>
      <div id="gameboard">
	<p>This is a placeholder for the gameboard.</p>
      </div>
    </div>
    <div id="login">
      <div id="loginwindow">
        <fieldset class="ui-border ui-container">
          <legend><h3>Login</h3></legend>
          <div id="infotext">
           Please login, or hit register<br/>
           if you do not have account yet.
          </div>
          <input type="text" id="username" size="10" maxlength="10" placeholder="Username">
          <input type="password" id="password" size="10" maxlength="20"  placeholder="Password">
	  <div id="loginbuttons">
            <input class="button ui-space-blue" id="login_button" type="submit" value="Login" onclick="login()">
            <input class="button ui-space-blue" id="register_button" type="submit" value="Register" onclick="register()">
	  </div>
        </fieldset>
      </div>
    </div>
    <div style="width:100%;position:absolute;top:50%;text-align:center;">
      <div id="challengebox" >
       <fieldset class="ui-border ui-container">
         <legend><h3>Incoming Online Challenge</h3></legend>
         <div id="challenge">
         </div>
       </fieldset>
      </div>
    </div>

    <div id="gameover">
      
      <div class="trophies">

        <img class="bronze" style="float:left;" src="./media/goblet-bronze.png"/>
        <img class="bronze" style="float:right;" src="./media/goblet-bronze.png"/>

	<div class="stats" >
	  <h1>Game over!</h1>
	  Collected: <h1 id="numcollected">0</h1><br/>
	  Result: <div>
	    <img id="star1" class="star" src="./media/star.png"/>
	    <img id="star2" class="star" src="./media/star.png"/>
	    <img id="star3" class="star" src="./media/star.png"/>
	  </div>
	</div>
      </div>

    </div>

    <div id="chat">
      <fieldset class="ui-border ui-container">
        <legend><strong>Messages</strong></legend>
        <div id="chatbox">
          <div id="messagebox"></div>
        </div>
        <div id="sendmessage">
          Send: <input type="text" id="chatmessage" size="40" maxlength="140" onkeypress="return chatKeypress(event)">
        </div>
      </fieldset>
      <div id="chathandle" 
          onmouseover="messageHandler.game.showChat();"
          onclick="messageHandler.game.hideChat();">^</div>
    </div>

  </div>
</body>
</html>
